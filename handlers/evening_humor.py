import asyncio
import random
from datetime import datetime
from typing import List

from aiogram import Bot
from database.queries import get_active_chat_ids
from logger import logger
from config import REQUEST_DELAY

# –°–ø–∏—Å–æ–∫ —é–º–æ—Ä–Ω—ã—Ö –≤–µ—á–µ—Ä–Ω–∏—Ö —Ñ—Ä–∞–∑
EVENING_HUMOR_PHRASES = [
    "üåÜ –í–æ—Ç –∏ –¥–µ–Ω—å –ø—Ä–æ—à–µ–ª! –ö—Ç–æ-—Ç–æ –±—É–ª–æ—á–∫–∞ –¥–Ω—è, –∞ –∫—Ç–æ-—Ç–æ —Ç–æ–ª—å–∫–æ –º–µ—á—Ç–∞–µ—Ç, –∫–∞–∫ –±—ã –µ–µ —Å—ä–µ—Å—Ç—å... ü•êüòã",
    "üåá –í–µ—á–µ—Ä–æ–∫ –ø–æ–¥–∫—Ä–∞–ª—Å—è! –°–µ–≥–æ–¥–Ω—è—à–Ω—è—è –±—É–ª–æ—á–∫–∞ –¥–Ω—è —É–∂–µ –æ—Å—Ç—ã–ª–∞, –Ω–æ –∑–∞–≤—Ç—Ä–∞ –ø–æ—è–≤–∏—Ç—Å—è –Ω–æ–≤–∞—è –≥–æ—Ä—è—á–∞—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å! üî•ü•ñ",
    "üåÖ –ó–∞–∫–∞—Ç –±—É–ª–æ—á–Ω–æ–≥–æ –¥–Ω—è! –û–¥–Ω–∏ —Å—á–∏—Ç–∞—é—Ç –æ—á–∫–∏, –¥—Ä—É–≥–∏–µ —Å—á–∏—Ç–∞—é—Ç –∫–∞–ª–æ—Ä–∏–∏ –æ—Ç —Å—ä–µ–¥–µ–Ω–Ω—ã—Ö –≤–æ–æ–±—Ä–∞–∂–∞–µ–º—ã—Ö –±—É–ª–æ—á–µ–∫... üìäüç©",
    "‚≠ê –ó–≤–µ–∑–¥—ã –∑–∞–∂–∏–≥–∞—é—Ç—Å—è, –∞ –Ω–∞—à–∏ –ø–µ–∫–∞—Ä–∏ –ø–æ–¥–≤–æ–¥—è—Ç –∏—Ç–æ–≥–∏! –ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ, —Å–Ω—è—Ç—Å—è –ª–∏ –±—É–ª–æ—á–∫–∞–º –¥–Ω—è –ª—é–¥–∏? üåüüë•",
    "üåÉ –¢–∏—à–∏–Ω–∞ –≤–µ—á–µ—Ä–∞ –Ω–∞—Ä—É—à–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ —Ö—Ä—É—Å—Ç–æ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –∫—Ä—É–∞—Å—Å–∞–Ω–æ–≤ –≤ –º–µ—á—Ç–∞—Ö –∏–≥—Ä–æ–∫–æ–≤... ü•êüí≠",
    "üåô –õ—É–Ω–∞ –≤–∑–æ—à–ª–∞, –ø–µ–∫–∞—Ä–Ω—è –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è, –∞ –±—É–ª–æ—á–Ω–∏–∫–∏ —É—Ö–æ–¥—è—Ç —Å–ø–∞—Ç—å —Å –º—ã—Å–ª—è–º–∏ –æ –∑–∞–≤—Ç—Ä–∞—à–Ω–µ–º —Ç–µ—Å—Ç–µ! üåõ‚ö°",
    "üåÜ –î–µ–Ω—å –æ–∫–æ–Ω—á–µ–Ω, —Å—á–µ—Ç—á–∏–∫ –æ—á–∫–æ–≤ –æ–±–Ω—É–ª–µ–Ω –≤ —Å–µ—Ä–¥—Ü–∞—Ö, –Ω–æ –Ω–∞–¥–µ–∂–¥–∞ –Ω–∞ –±—É–ª–æ—á–Ω–æ–µ –≤–µ–ª–∏—á–∏–µ –≤–µ—á–Ω–∞! üí´‚ù§Ô∏è",
    "üé≠ –ó–∞–Ω–∞–≤–µ—Å –æ–ø—É—Å–∫–∞–µ—Ç—Å—è –Ω–∞ —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–π —Å–ø–µ–∫—Ç–∞–∫–ª—å '–ö—Ç–æ –∫–æ–≥–æ –ø–µ—Ä–µ–±—É–ª–æ—á–∏—Ç'! –ó–∞–≤—Ç—Ä–∞ ‚Äî –Ω–æ–≤—ã–µ —Ä–æ–ª–∏! üé™üé®",
    "üåá –í–µ—á–µ—Ä–Ω—è—è —Å–≤–æ–¥–∫–∞: –∫—Ç–æ-—Ç–æ —Å—Ç–∞–ª —Ç–µ–ø–ª—ã–º —Ö–ª–µ–±—É—à–∫–æ–º, –∫—Ç–æ-—Ç–æ –æ—Å—Ç–∞–ª—Å—è —á–µ—Ä—Å—Ç–≤–æ–π –∫–æ—Ä–æ—á–∫–æ–π... –î–æ –∑–∞–≤—Ç—Ä–∞! üì∞üçû",
    "üåÖ –°–æ–ª–Ω—Ü–µ —Å–µ–ª–æ, –Ω–æ –¥—É—Ö —Å–æ–ø–µ—Ä–Ω–∏—á–µ—Å—Ç–≤–∞ –≤ –ø–µ–∫–∞—Ä–Ω–µ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ —Å–ø–∏—Ç! –°–ª–∞–¥–∫–∏—Ö –±—É–ª–æ—á–Ω—ã—Ö —Å–Ω–æ–≤! üò¥ü•ê‚ú®",
]


async def send_evening_humor(bot: Bot):
    """–û—Ç–ø—Ä–∞–≤–∫–∞ –≤–µ—á–µ—Ä–Ω–µ–≥–æ —é–º–æ—Ä–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –≤–æ –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —á–∞—Ç—ã."""
    try:
        chat_ids = await get_active_chat_ids()
        if not chat_ids:
            logger.warning("–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —á–∞—Ç–æ–≤ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤–µ—á–µ—Ä–Ω–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π.")
            return

        # –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—É—é —Ñ—Ä–∞–∑—É
        humor_message = random.choice(EVENING_HUMOR_PHRASES)

        sent_count = 0
        error_count = 0

        for chat_id in chat_ids:
            try:
                await bot.send_message(chat_id=chat_id, text=humor_message)
                sent_count += 1
                logger.info(f"–í–µ—á–µ—Ä–Ω–µ–µ —é–º–æ—Ä–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ —á–∞—Ç {chat_id}")

                # –ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –æ—Ç–ø—Ä–∞–≤–∫–∞–º–∏ –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è flood control
                await asyncio.sleep(REQUEST_DELAY)

            except Exception as e:
                error_count += 1
                logger.error(
                    f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –≤–µ—á–µ—Ä–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç {chat_id}: {e}"
                )

        logger.info(
            f"–í–µ—á–µ—Ä–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã: —É—Å–ø–µ—à–Ω–æ {sent_count}, –æ—à–∏–±–æ–∫ {error_count}"
        )

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –≤–µ—á–µ—Ä–Ω–∏—Ö —é–º–æ—Ä–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π: {e}")


def get_random_evening_phrase() -> str:
    """–ü–æ–ª—É—á–∏—Ç—å —Å–ª—É—á–∞–π–Ω—É—é –≤–µ—á–µ—Ä–Ω—é—é —Ñ—Ä–∞–∑—É."""
    return random.choice(EVENING_HUMOR_PHRASES)


def get_moscow_hour() -> int:
    """–ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–∏–π —á–∞—Å –ø–æ –º–æ—Å–∫–æ–≤—Å–∫–æ–º—É –≤—Ä–µ–º–µ–Ω–∏ (UTC+3)."""
    from datetime import timezone, timedelta

    moscow_tz = timezone(timedelta(hours=3))
    moscow_time = datetime.now(moscow_tz)
    return moscow_time.hour


def is_evening_time() -> bool:
    """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –ø–æ–¥—Ö–æ–¥—è—â–µ–µ –ª–∏ –≤—Ä–µ–º—è –¥–ª—è –≤–µ—á–µ—Ä–Ω–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (18:00-22:00 –ú–°–ö)."""
    hour = get_moscow_hour()
    return 18 <= hour <= 22


def get_random_evening_cron() -> str:
    """–ü–æ–ª—É—á–∏—Ç—å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª—è –≤–µ—á–µ—Ä–Ω–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π - 20:00 –ú–°–ö –∫–∞–∂–¥—ã–π –¥–µ–Ω—å."""
    # –ü—Ä–æ—Å—Ç–æ–µ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è: 20:00 –ú–°–ö –∫–∞–∂–¥—ã–π –¥–µ–Ω—å
    cron_schedule = "0 20 * * *"
    
    logger.info(f"–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ –≤–µ—á–µ—Ä–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞ 20:00 –ú–°–ö –∫–∞–∂–¥—ã–π –¥–µ–Ω—å - cron: {cron_schedule}")
    
    return cron_schedule


def get_evening_schedule_info() -> dict:
    """–ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–∫—É—â–µ–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–∏ –≤–µ—á–µ—Ä–Ω–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π."""
    moscow_hour = get_moscow_hour()
    from datetime import timezone, timedelta

    moscow_tz = timezone(timedelta(hours=3))
    moscow_time = datetime.now(moscow_tz)

    return {
        "current_moscow_time": moscow_time.strftime("%H:%M:%S"),
        "current_moscow_hour": moscow_hour,
        "is_evening_time": is_evening_time(),
        "evening_window": "18:00-22:00 –ú–°–ö",
        "next_possible_time": "–°–µ–≥–æ–¥–Ω—è" if moscow_hour < 22 else "–ó–∞–≤—Ç—Ä–∞",
    }
